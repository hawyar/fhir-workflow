{"version":3,"file":"workflow.cjs","sources":["../lib/fsm.ts","../lib/workflow.ts"],"sourcesContent":["import { createMachine, interpret } from \"xstate\";\n\nexport class FSM {\n    machine: any;\n    service: any;\n    constructor (config: any, actions: any) {\n      this.machine = createMachine({\n        predictableActionArguments: true,\n        id: 'fsm',\n        strict: true,\n        ...config\n      }, actions);\n      this.service = interpret(this.machine)\n    }\n  }","import { Appointment, AppointmentResponse, Encounter, Schedule, Slot} from \"fhir/r4\";\nimport crypto from \"crypto\";\nimport { FSM } from \"./fsm\";\n\nexport class AppointmentWorkflow {\n  private name: string\n  private id: string\n  private appointment: Appointment | null = null\n  private slot: Slot | null = null\n  private response: AppointmentResponse | null = null\n  private encounter: Encounter | null = null\n  readonly createdAt: Date\n  readonly updatedAt: Date\n  fsm: FSM\n  constructor (name: string) {\n    this.name = name\n    this.id = crypto.randomBytes(16).toString('hex')\n    this.createdAt = new Date()\n    this.updatedAt = new Date()\n    this.slot = null\n    this.appointment = null\n    this.response = null\n    this.encounter = null\n    this.fsm = new FSM({\n      id: 'app-workflow',\n      initial: 'draft',\n      context: {\n        appointment: null,\n        slot: null,\n        response: null,\n        encounter: null\n      },\n      states: {\n        draft: {\n          entry: ['createSchedule'],\n          on: {\n            READY: 'ready',\n            REQUEST: 'requested',\n            CANCEL: 'cancelled'\n          }\n        },\n        ready: {\n          on: {\n            RESOLVE: 'in-progress'\n          }\n        },\n        requested: {\n          entry: ['requestAppointment','processRequest'],\n          on: {\n            ACCEPT: 'accepted',\n            REJECT: 'rejected',\n            RECEIVE: 'received'\n          }\n        },\n        received: {\n          on: {\n            ACCEPT: 'accepted',\n            REJECT: 'rejected'\n          }\n        },\n        rejected: {\n          on: {\n            STOP: 'done'\n          }\n        },\n        accepted: {\n          on: {\n            RESOLVE: 'in-progress'\n          }\n        },\n        'in-progress': {\n          on: {\n            HOLD: 'on-hold',\n            COMPLETE: 'completed',\n            FAILED: 'failed'\n          }\n        },\n        completed: {\n          on: {\n            STOP: 'done'\n          }\n        },\n        failed: {\n          on: {\n            STOP: 'done'\n          }\n        },\n        'on-hold': {\n          on: {\n            UNHOLD: 'in-progress'\n          }\n        },\n        cancelled: {\n          on: {\n            STOP: 'done'\n          }\n        },\n        done: {\n          type: 'final'\n        }\n      }\n    }, {\n      actions: {\n        createSchedule: (context: any, event: any) => {\n          const schedule: Schedule = {\n            id: crypto.randomBytes(16).toString('hex'),\n            actor: [{ reference: `Practitioner/123` }],\n            resourceType: 'Schedule'\n          }\n\n          const slot: Slot = {\n            id: crypto.randomBytes(6).toString(\"hex\"),\n            resourceType: 'Slot',\n            status: 'free',\n            end: \"\",\n            schedule: {\n                reference: `Schedule/${schedule.id}`\n            },\n            start: '2021-01-01T09:00:00Z'\n          }\n          context.slot = slot\n        },\n        requestAppointment: (context: any, event: any) => {\n            const appointment: Appointment = {\n              participant: [{ status: 'accepted', actor: { reference: `Patient/${crypto.randomBytes(6).toString(\"hex\")}` } }],\n              resourceType: 'Appointment',\n              status: 'proposed',\n              slot: [{ reference: `Slot/${context.slot.id}` }]\n            }\n            appointment.status = 'pending'\n            context.appointment = appointment\n        },\n        processRequest: (context: any, event: any) => {\n          context.slot.status = \"busy-tentative\"\n        },\n      }\n    })\n  }\n}\n\nexport function scheduleAppointment(name: string): void {\n  const workflow = new AppointmentWorkflow(name)\n  console.log(workflow)\n  // const current = workflow.fsm.service\n  // current.start()\n  // current.send('REQUEST')\n}\n"],"names":["FSM","constructor","config","actions","machine","service","createMachine","predictableActionArguments","id","strict","interpret","AppointmentWorkflow","name","appointment","slot","response","encounter","createdAt","updatedAt","fsm","crypto","randomBytes","toString","Date","initial","context","states","draft","entry","on","READY","REQUEST","CANCEL","ready","RESOLVE","requested","ACCEPT","REJECT","RECEIVE","received","rejected","STOP","accepted","HOLD","COMPLETE","FAILED","completed","failed","UNHOLD","cancelled","done","type","createSchedule","event","schedule","actor","reference","resourceType","status","end","start","requestAppointment","participant","processRequest","scheduleAppointment","workflow","console","log"],"mappings":"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"}
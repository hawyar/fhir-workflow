{"version":3,"file":"workflow.js","sources":["../lib/workflow.ts"],"sourcesContent":["import { EventEmitter } from 'events'\nimport {AppointmentResponse, Encounter, Practitioner, Schedule, Slot} from \"fhir/r4\";\nimport { Appointment } from \"fhir/r4\";\nimport {createMachine, interpret} from \"xstate\";\nimport crypto from \"crypto\";\n\nclass FSM {\n  machine: any;\n  service: any;\n  constructor (config: any, actions: any) {\n    this.machine = createMachine({\n      predictableActionArguments: true,\n      id: 'fsm',\n      strict: true,\n      ...config\n    }, actions);\n    this.service = interpret(this.machine)\n  }\n}\n\nconst ee = new EventEmitter()\n// const fsm =  new FSM({\n//   id: 'app-workflow',\n//   initial: 'draft',\n//   context: {\n//     appointment: null,\n//     slot: null,\n//     response: null,\n//     encounter: null\n//   },\n//   states: {\n//     draft: {\n//       entry: 'createSchedule',\n//       on: {\n//         READY: 'ready',\n//         REQUEST: 'requested',\n//         CANCEL: 'cancelled'\n//       }\n//     },\n//     ready: {\n//       on: {\n//         RESOLVE: 'in-progress'\n//       }\n//     },\n//     requested: {\n//       on: {\n//         ACCEPT: 'accepted',\n//         REJECT: 'rejected',\n//         RECEIVE: 'received'\n//       }\n//     },\n//     received: {\n//       on: {\n//         ACCEPT: 'accepted',\n//         REJECT: 'rejected'\n//       }\n//     },\n//     rejected: {\n//       on: {\n//         STOP: 'done'\n//       }\n//     },\n//     accepted: {\n//       on: {\n//         RESOLVE: 'in-progress'\n//       }\n//     },\n//     'in-progress': {\n//       on: {\n//         HOLD: 'on-hold',\n//         COMPLETE: 'completed',\n//         FAILED: 'failed'\n//       }\n//     },\n//     completed: {\n//       on: {\n//         STOP: 'done'\n//       }\n//     },\n//     failed: {\n//       on: {\n//         STOP: 'done'\n//       }\n//     },\n//     'on-hold': {\n//       on: {\n//         UNHOLD: 'in-progress'\n//       }\n//     },\n//     cancelled: {\n//       on: {\n//         STOP: 'done'\n//       }\n//     },\n//     done: {\n//       type: 'final'\n//     }\n//   }\n// }, {\n//   actions: {\n//     createSchedule: (context: any, event: any) => {\n//       // prepare free slot\n//       const slot: Slot = {\n//         resourceType: 'Slot',\n//         status: 'free',\n//         end: \"\", schedule: undefined,\n//         start: '2021-01-01T09:00:00Z'\n//       }\n//       console.log(\"schedule is created/published\", context, event)\n//     }\n//   }\n// })\n\nexport class AppointmentWorkflow {\n  readonly name: string\n  readonly createdAt: Date\n  private hasStarted: boolean = false\n  private appointment: Appointment | null = null\n  private slot: Slot | null = null\n  private response: AppointmentResponse | null = null\n  private encounter: Encounter | null = null\n  ee: EventEmitter\n  fsm: any\n  constructor (name: string) {\n    this.name = name\n    this.createdAt = new Date()\n    this.hasStarted = false\n    this.slot = null\n    this.appointment = null\n    this.response = null\n    this.encounter = null\n    this.ee = ee\n    this.fsm = new FSM({\n      id: 'app-workflow',\n      initial: 'draft',\n      context: {\n        appointment: null,\n        slot: null,\n        response: null,\n        encounter: null\n      },\n      states: {\n        draft: {\n          entry: ['createSchedule', 'signal'],\n          on: {\n            READY: 'ready',\n            REQUEST: 'requested',\n            CANCEL: 'cancelled'\n          }\n        },\n        ready: {\n          on: {\n            RESOLVE: 'in-progress'\n          }\n        },\n        requested: {\n          entry: ['requestAppointment','processRequest', 'signal'],\n          on: {\n            ACCEPT: 'accepted',\n            REJECT: 'rejected',\n            RECEIVE: 'received'\n          }\n        },\n        received: {\n          on: {\n            ACCEPT: 'accepted',\n            REJECT: 'rejected'\n          }\n        },\n        rejected: {\n          on: {\n            STOP: 'done'\n          }\n        },\n        accepted: {\n          on: {\n            RESOLVE: 'in-progress'\n          }\n        },\n        'in-progress': {\n          on: {\n            HOLD: 'on-hold',\n            COMPLETE: 'completed',\n            FAILED: 'failed'\n          }\n        },\n        completed: {\n          on: {\n            STOP: 'done'\n          }\n        },\n        failed: {\n          on: {\n            STOP: 'done'\n          }\n        },\n        'on-hold': {\n          on: {\n            UNHOLD: 'in-progress'\n          }\n        },\n        cancelled: {\n          on: {\n            STOP: 'done'\n          }\n        },\n        done: {\n          type: 'final'\n        }\n      }\n    }, {\n      actions: {\n        createSchedule: (context: any, event: any) => {\n          const schedule: Schedule = {\n            id: crypto.randomBytes(16).toString('hex'),\n            actor: [{ reference: `Practitioner/123` }],\n            resourceType: 'Schedule'\n          }\n\n          const slot: Slot = {\n            id: crypto.randomBytes(6).toString(\"hex\"),\n            resourceType: 'Slot',\n            status: 'free',\n            end: \"\",\n            schedule: {\n                reference: `Schedule/${schedule.id}`\n            },\n            start: '2021-01-01T09:00:00Z'\n          }\n          context.slot = slot\n        },\n        requestAppointment: (context: any, event: any) => {\n            const appointment: Appointment = {\n              participant: [{ status: 'accepted', actor: { reference: `Patient/${crypto.randomBytes(6).toString(\"hex\")}` } }],\n              resourceType: 'Appointment',\n              status: 'proposed',\n              slot: [{ reference: `Slot/${context.slot.id}` }]\n            }\n            appointment.status = 'pending'\n            context.appointment = appointment\n        },\n        processRequest: (context: any, event: any) => {\n          context.slot.status = \"busy-tentative\"\n        },\n        signal(context: any, event: any) {\n          ee.emit('ctx', context)\n        }\n      }\n    })\n  }\n}\n\nexport function scheduleAppointment(name: string) {\n  const workflow = new AppointmentWorkflow(name || \"my-workflow\")\n  const current = workflow.fsm.service\n\n  current.start()\n  current.send('REQUEST')\n}\n"],"names":["FSM","constructor","config","actions","machine","service","createMachine","predictableActionArguments","id","strict","interpret","ee","EventEmitter","AppointmentWorkflow","name","createdAt","hasStarted","appointment","slot","response","encounter","fsm","Date","initial","context","states","draft","entry","on","READY","REQUEST","CANCEL","ready","RESOLVE","requested","ACCEPT","REJECT","RECEIVE","received","rejected","STOP","accepted","HOLD","COMPLETE","FAILED","completed","failed","UNHOLD","cancelled","done","type","createSchedule","event","schedule","crypto","randomBytes","toString","actor","reference","resourceType","status","end","start","requestAppointment","participant","processRequest","signal","emit","scheduleAppointment","workflow","current","send"],"mappings":"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"}